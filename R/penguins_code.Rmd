---
title: "Palmer penguins paper code"
author: "Allison Horst"
date: "7/2/2020"
output: html_document
---

This document contains accompanying code for all figures, tables and analyses presented in "Palmer Archipelago (Antarctica) penguins data: an alternative to Edgar Anderson's *Iris* data." 

## Set-up and required packages: 

```{r setup, include = TRUE, message = FALSE, warning = FALSE}

# ---- Code options ---- #
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# ---- Packages required ---- # 
library(tidyverse)
library(here)
library(palmerpenguins)
library(kableExtra)
library(patchwork)
library(gt)
library(GGally)
library(recipes)
library(shadowtext)

# ---- Set default ggplot theme to theme_minimal ---- #
theme_set(theme_minimal())

```

## Table 1: *iris* sample

```{r iris_sample}
set.seed(1900)
sample_n(iris, 6) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE)
```

## Table 2: *penguins* sample

```{r penguin_sample}
set.seed(1900)
sample_n(penguins, 6) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE)
```

## Table 3: Sample size, *iris* (by species) and *penguins* (by species and sex)

### NOTE: I am not happy about this method to convert NA values (for missing factor levels) to 0. 

```{r compare_counts}

# ---- Iris counts by species ---- #
iris_counts <- iris %>% 
  count(Species) %>% 
  rename(`Iris species` = Species)

# ---- Penguin counts by species and sex ---- #
penguin_counts <- penguins %>% 
  mutate(sex = str_to_title(sex)) %>% 
  count(species, sex) %>% 
  pivot_wider(names_from = sex, values_from = n) %>% 
  replace_na(list(`NA` = 0)) %>% 
  as.data.frame() %>% 
  rename(`Penguin species` = species)

# ---- Combine iris and penguin counts ---- #

iris_penguin_n <- cbind(iris_counts, penguin_counts) %>% 
  rename(`Sample size` = n)

# ---- Create a finalized table using `gt` package ---- #
iris_penguin_n %>%
  gt() %>%
  tab_spanner(
    label = "Iris sample size (by species)",
    columns = vars(`Iris species`, `Sample size`)
  ) %>%
  tab_spanner(
    label = "Penguin sample size (by species and sex)",
    columns = vars(`Penguin species`, `Female`, `Male`, `NA`)
  ) %>%
  tab_footnote(
    footnote = "Note: Here, penguin sample sizes are split by species and sex, and could be further divided by island. NA column for penguins indicate observations where sex was not recorded.",
    location = cells_column_labels(
      columns = vars(`Penguin species`)
    )
  )

```

## Figure 1: *penguins* pairs plot

```{r penguin_pairs}
penguins %>%
  select(species, where(is.numeric)) %>% 
  ggpairs(aes(color = species, shape = species),
          columns = c("flipper_length_mm", "body_mass_g", 
                      "bill_length_mm", "bill_depth_mm"),
          columnLabels = c("Flipper length (mm)","Body mass (g)", "Bill length (mm)", "Bill depth (mm)"),
          upper = list(continuous = wrap("cor", size = 3))) +
  scale_fill_manual(values = c("darkorange","purple","cyan4")) +
  scale_color_manual(values = c("darkorange","purple","cyan4")) +
  scale_shape_manual(values = c(15,16,17)) +
  theme_minimal() +
  theme(
        text = element_text(size = 10, family = "Arial"),
        panel.grid.major = element_line(colour = NA),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(color = "gray80", fill = NA)
        )
```

## Figure 2: *iris* pairs plot

```{r iris_pairs}
iris %>%
  ggpairs(aes(color = Species),
          columns = c("Petal.Length", "Petal.Width", 
                      "Sepal.Length", "Sepal.Width"),
          columnLabels = c("Petal length (cm)","Petal width (cm)", "Sepal length (cm)", "Sepal width (cm)"),
          upper = list(continuous = wrap("cor", size = 3))) +
  scale_colour_manual(values = c("darkorange","purple","cyan4")) +
  scale_fill_manual(values = c("darkorange","purple","cyan4")) +
  theme_minimal() +
  theme(
        text = element_text(size = 10, family = "Arial"),
        panel.grid.major = element_line(colour = NA),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "gray90", color = "gray90")
        )
```

## Figure 3: Visualize selected linear relationships

```{r linear_viz, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 6}

# ---- Penguin scatterplot, species included ---- # 

penguin_flip_mass_scatter <- ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(aes(color = species, shape = species), size = 1.5, alpha = 0.5) +
  geom_smooth(method = "lm", aes(group = species, color = species), se = FALSE, show.legend = FALSE) +
  theme_minimal() +
  scale_color_manual(values = c("darkorange","darkorchid","cyan4")) +
  theme(legend.position = "bottom") +
  labs(x = "Flipper length (mm)", 
       y = "Body mass (g)") +
  theme(plot.title.position = "plot",
        panel.border = element_rect(fill = NA, color = "gray70"))

# ----- Penguin scatterplot, species omitted ---- # 

penguin_flip_mass_scatter_all <- ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(color = "gray50", size = 1.5, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  theme_minimal() +
  labs(x = "Flipper length (mm)", 
       y = "Body mass (g)") +
  theme(plot.title.position = "plot",
        panel.border = element_rect(fill = NA, color = "gray70"))

# ---- Iris scatterplot, species included ---- #

iris_petal_scatter <- ggplot(iris, aes(x = Petal.Length, y = Petal.Width)) +
  geom_point(aes(color = Species, size = Species, shape = Species), size = 1.5, alpha = 0.5) +
  geom_smooth(aes(group = Species, color = Species), method = "lm", se = FALSE, show.legend = FALSE) +
  theme_minimal() +
  scale_color_manual(values = c("darkorange","darkorchid","cyan4")) +
  theme(legend.position = "bottom") +
  labs(x = "Petal length (cm)",
       y = "Petal width (cm)") +
  theme(plot.title.position = "plot",
        panel.background = element_rect(fill = "gray90", color = "gray90"))

# ---- Iris scatterplot, species omitted ---- #

iris_petal_scatter_all <- ggplot(iris, aes(x = Petal.Length, y = Petal.Width)) +
  geom_point(color = "gray50", size = 1.5, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  theme_minimal() +
  labs(x = "Petal length (cm)",
       y = "Petal width (cm)") +
  theme(plot.title.position = "plot",
        panel.background = element_rect(fill = "gray90", color = "gray90")) 

(penguin_flip_mass_scatter_all + iris_petal_scatter_all) / (penguin_flip_mass_scatter + iris_petal_scatter) + plot_annotation(tag_levels = 'A')
```

## Figure 4: Simpson's Paradox example

```{r simpsons_paradox, fig.width = 8, fig.height = 4}
# Simpson's Paradox example (bill dimensions)
simpson_nospecies <- ggplot(data = penguins, aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(color = "gray40", alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  theme_minimal() +
  theme(panel.border = element_rect(fill = NA, color = "gray70")) +
  labs(x = "Bill length (mm)", y = "Bill depth (mm)")

simpson_wspecies <- ggplot(data = penguins, aes(x = bill_length_mm, y = bill_depth_mm, group = species)) +
  geom_point(aes(color = species, shape = species), size = 2, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, aes(color = species)) +
  scale_color_manual(values = c("darkorange","darkorchid","cyan4")) +
  theme_minimal() +
  theme(panel.border = element_rect(fill = NA, color = "gray70"),
        legend.position = c(0.16,0.14)) +
  labs(x = "Bill length (mm)", y = "Bill depth (mm)")

(simpson_nospecies | simpson_wspecies) + plot_annotation(tag_levels = 'A')

```

## Figure 5: PCA 

```{r pca, fig.height = 8, fig.width = 8}

# ---- Penguins data prep ---- #
penguin_recipe <-
  recipe(~., data = penguins) %>% 
  update_role(species, island, sex, new_role = "id") %>% 
  step_naomit(all_predictors()) %>% 
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(), id = "pca") %>% 
  prep()

# ---- Penguin PCA ---- #
penguin_pca <- 
  penguin_recipe %>% 
  tidy(id = "pca") 

# ---- Get penguins % variance ---- #

penguin_percvar <- penguin_recipe %>% 
  tidy(id = "pca", type = "variance") %>% 
  dplyr::filter(terms == "percent variance") 

# ---- Clean penguins PCA outcome ---- #

pca_wider <- penguin_pca %>% 
  tidyr::pivot_wider(names_from = component, id_cols = terms)

# ---- Define arrow style for biplot ---- #
arrow_style <- arrow(length = unit(.05, "inches"),
                     type = "closed")

# ---- Make penguins biplot ---- #
pca_plot <-
  juice(penguin_recipe) %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(color = species, shape = species), 
             alpha = 0.5, 
             size = 2) +
  scale_colour_manual(values = c("darkorange","purple","cyan4")) 

penguins_biplot <- pca_plot +
  geom_segment(data = pca_wider,
               aes(xend = PC1, yend = PC2), 
               x = 0, 
               y = 0, 
               arrow = arrow_style) + 
  geom_shadowtext(data = pca_wider,
            aes(x = PC1, y = PC2, label = terms), 
            nudge_x = c(0.7,0.7,1.7,1.2), 
            nudge_y = c(-0.1,-0.2,0.1,-0.1),
            size = 4, 
            color = "black",
            bg.color = "white") +
  theme(legend.position = "bottom",
        panel.border = element_rect(color = "gray70", fill = NA))

# For positioning (above): 
# 1: bill_length
# 2: bill_depth
# 3: flipper length
# 4: body mass

# ---- Penguins scree plot ---- #
penguin_screeplot <- penguin_percvar %>% 
  ggplot(aes(x = component, y = value)) + 
  geom_col(fill = "gray50") + 
  scale_x_continuous(limits = c(0, 5), expand = c(0,0)) + 
  scale_y_continuous(limits = c(0,100), expand = c(0,0)) +
  ylab("% of total variance") +
  geom_text(aes(label = round(value,2)), vjust=-0.25) +
  theme(panel.border = element_rect(color = "gray70", fill = NA))


#############################

# Iris PCA

# ---- Prep iris data for PCA ---- #

iris_recipe <-
  recipe(~., data = iris) %>% 
  update_role(Species, new_role = "id") %>% 
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(), id = "pca") %>% 
  prep()

# ---- Iris PCA ---- #

iris_pca <- 
  iris_recipe %>% 
  tidy(id = "pca") 

# ---- Iris PCA loadings into wider format ---- #
iris_wider <- iris_pca %>% 
  tidyr::pivot_wider(names_from = component, id_cols = terms)

# ---- Make iris PCA biplot ---- #

iris_pca_plot <-
  juice(iris_recipe) %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(color = Species, shape = Species), 
             alpha = 0.5, 
             size = 2) +
  scale_colour_manual(values = c("darkorange","purple","cyan4")) 

iris_biplot <- iris_pca_plot +
  geom_segment(data = iris_wider,
               aes(xend = PC1, yend = PC2), 
               x = 0, 
               y = 0, 
               arrow = arrow_style) + 
  geom_shadowtext(data = iris_wider,
            aes(x = PC1, y = PC2, label = terms), 
            nudge_x = c(0.5,0.3,1,1.2), 
            nudge_y = c(-0.1,-0.2,0.1,-0.1),
            size = 4, 
            color = "black",
            bg.color = "white") +
  theme(panel.background = element_rect(fill = "gray90", color = "gray90"),
        legend.position = "bottom")

# ---- Get iris % variance ---- #
iris_percvar <- iris_recipe %>% 
  tidy(id = "pca", type = "variance") %>% 
  dplyr::filter(terms == "percent variance")

# ---- Make iris scree plot ---- #
iris_screeplot <- iris_percvar %>% 
  ggplot(aes(x = component, y = value)) + 
  geom_col(fill = "gray50") + 
  scale_x_continuous(limits = c(0, 5), expand = c(0,0)) + 
  scale_y_continuous(limits = c(0,100), expand = c(0,0)) +
  ylab("% of total variance") +
  geom_text(aes(label = round(value,2)), vjust=-0.25) +
  theme(panel.background = element_rect(fill = "gray90", color = "gray90"))

# ---- Create compound figure (uses patchwork) ---- #
(penguins_biplot | iris_biplot) / (penguin_screeplot | iris_screeplot) + plot_annotation(tag_levels = 'A')
```

## Figure 6: k-means

Simplified to two variables for each dataset (could be performed for all 4 numeric variables instead).

### NOTE: I am not happy about this method to convert NA values (for missing factor levels) to 0. 

```{r penguin_kmeans}

# ---- PENGUIN BILL DIMENSIONS K-MEANS ---- #

# ---- Simplify & drop missings ---- #

p_bills <- penguins %>% 
  select(species, bill_length_mm, bill_depth_mm) %>% 
  drop_na()

# ---- Remove species factor & scale ---- # 
p_bills_nospecies <- p_bills %>% 
  select(-species) %>% 
  scale() %>% 
  as.data.frame()

# ---- K-means on penguin bill dimensions (k = 3, w/20 centroid starts) ---- #

p_bills_kmeans <- kmeans(p_bills_nospecies, centers = 3, nstart = 20)

# ---- Bind cluster assignments to the data ---- #

p_kmeans_clusters <- cbind(p_bills_nospecies, cluster = as.factor(p_bills_kmeans$cluster), species = p_bills$species)

# ---- Plot clusters ---- #

p_kmeans_gg <- ggplot(p_kmeans_clusters, aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_text(aes(label = cluster, color = species)) +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("darkorange","darkorchid","cyan4"))

# ---- Get counts in each cluster by species ---- #
p_cluster_counts <- p_kmeans_clusters %>% 
  count(species, cluster) %>% 
  pivot_wider(names_from = species, values_from = n) %>% 
  arrange(cluster)

```

```{r iris_kmeans}

# ---- IRIS PETALS K-MEANS ---- #

# ---- Subset iris species & petal dimensions ---- #
iris_petals <- iris %>% 
  select(Species, Petal.Length, Petal.Width)

# ---- remove species factor & scale petal dimensions ---- #

ip_nospecies <- iris_petals %>% 
  select(-Species) %>% 
  scale() %>% 
  as.data.frame()

# ---- k-means on iris petal dimensions (k = 3, w/20 centroid starts) ---- #

set.seed(1967)
ip_kmeans <- kmeans(ip_nospecies, centers = 3, nstart = 20)

# ---- Bind clusters to the data ---- #

iris_kmeans_clusters <- cbind(ip_nospecies, cluster = as.factor(ip_kmeans$cluster), species = iris$Species)

# ---- Plot clusters ---- #  
iris_kmeans_gg <- ggplot(iris_kmeans_clusters, aes(x = Petal.Length, y = Petal.Width)) +
  geom_text(aes(label = cluster, color = species)) +
   theme(legend.position = "bottom",
         panel.background = element_rect(fill = "gray92", color = "gray90")) +
  scale_color_manual(values = c("darkorange","darkorchid","cyan4"))

# ---- Get counts in each cluster by species ---- #
iris_cluster_counts <- iris_kmeans_clusters %>% 
  count(species, cluster) %>% 
  pivot_wider(names_from = species, values_from = n) %>% 
  arrange(cluster)

```

```{r kmeans_figs}

# ---- Combine k-means plots with patchwork ---- #

(p_kmeans_gg | iris_kmeans_gg) + plot_annotation(tag_levels = "A")

# ---- Make table of cluster assignments ---- #

kmeans_2var_table <- cbind(p_cluster_counts, iris_cluster_counts) %>% 
  replace_na(list(`Adelie` = 0, `setosa` = 0, `versicolor` = 0, `virginica` = 0)) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE) %>% 
  column_spec(c(5:8), background = "gainsboro") %>% 
  add_header_above(c("Penguins cluster assignments" = 4, "Iris cluster assignments" = 4))

# ---- Return table ---- #

kmeans_2var_table
```
